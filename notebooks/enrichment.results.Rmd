---
title: "Enrichment + Rescue Results"
author: "Siddharth Reed"
date: "`r Sys.Date()`"
output: 
    html_document:
        keep_md: true
        toc: true
        toc_float: true
        theme: paper
        code_folding: hide
        df_print: paged
---

<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Set Up

```{r knitr}
library(knitr)
knitr::opts_chunk$set(
    dev=c('png', 'pdf', 'tiff'),
    dpi=300
)
```
Import utilities + dependences
```{r locations}
library(here)
here::i_am('notebooks/enrichment.results.Rmd')
BASE_DIR <- here()
SCRIPT_DIR <- here('scripts')
source(file.path(SCRIPT_DIR, 'locations.R'))
glue('Results are located at {ENRICHMENTS_DIR}')
glue('Data about which genes are rescued is here: {RESCUED_GENES_RESULTS_FILE}')
glue('DEG Results of Untreated XDP vs Untreated Controls is here: {XDP_DEG_RESULTS_FILE}')
glue('Functional enrichments of XDP FDR DEGs is here: {ENRICHMENTS_FDR_FILE}')
glue('Functional enrichments of XDP Nominal DEGs is here: {ENRICHMENTS_NOMINAL_FILE}')
```
```{r dependencies}
source(file.path(SCRIPT_DIR, 'constants.R'))
source(file.path(SCRIPT_DIR, 'glm_utils.R'))
source(file.path(SCRIPT_DIR, 'enrichment_utils.R'))
source(file.path(SCRIPT_DIR, 'data_utils.R'))
source(file.path(SCRIPT_DIR, 'rescue_utils.R'))
library(tidyverse)
library(magrittr)
```

# Prepare data

Load annotation data 
```{r load_data, rows.print=5, message=FALSE, results=FALSE}
gene_ids.mapping.df <- 
    GENE_ID_MAPPING_FILE %>% 
    read_tsv(show_col_types=FALSE)
sample.metadata.df <- 
    SAMPLE_METADATA_FILE %>%
    read_tsv(show_col_types=FALSE) %>% 
    filter(Exclude == 'NO') %>% 
    dplyr::select(-c(Exclude))
con_vs_xdp.results.df <- 
    XDP_DEG_RESULTS_FILE %>% 
    read_tsv(show_col_types=FALSE) %>% 
    filter(Contrast == 'ConditionNO.XDP vs ConditionNO.CON') %>% 
    dplyr::select(-c(Contrast))
functional.groups.df <- 
    load_all_annotations() %>% 
    format_functional_groups()
```
Here load all the gene rescue data i.e. for each treatment (7 ASOs + dSVA) categorize all genes as follows in the `isRescued` column. So this table has 1 row per rescue results (i.e. ~20K genes x 8 Treatment rows) with multiple columns describing the individual rescue results.
```{r generate_rescue_results}
rescued_genes.df <- 
    check_cached_results(
        results_file=RESCUED_GENES_RESULTS_FILE,
        force_redo=FALSE,
        return_data=TRUE,
        show_col_types=FALSE,
        results_fnc=get_all_rescue_results,
        ENRICHMENTS_DIR=ENRICHMENTS_DIR,
        inverse_baseline_df=con_vs_xdp.results.df %>% mutate(lfc=-lfc),
        gene_ids.mapping.df=gene_ids.mapping.df
    )
```

# Generate Enrichment Results

## TAF1 target vs DEG enrichments

Fisher test p-value of whether XDP vs CON DEGs (FDR < 0.1, abs(lfc) >= 0) overlap with genes targeted by TAF1.
```{r target_enrichment}
do_fisher_test(
    query_genes=con_vs_xdp.results.df %>% filter(is.Signature) %>% pull(EnsemblID),
    term_genes=con_vs_xdp.results.df %>% filter(is.TAF1.target) %>% pull(EnsemblID),
    background_genes=con_vs_xdp.results.df %>% pull(EnsemblID)
) %>% 
dplyr::select(-c(term_and_hit_genes)) %>% t()
```

Now we generate the enrichment results, so each row represents the results of 1 fisher test comparing a functional gene group (GO Term) vs 1 group of genes (e.g. rescued genes)

## XDP DEGs Enrichments

### FDR (FDR < 0.1)

Load gene list for `NO.CON vs NO.XDP` DEGs with FDR < 0.1
```{r GeneList_FDR}
gene_list.FDR <- 
    con_vs_xdp.results.df %>%
    filter(fdr < 0.1) %>%
    pull(gene_name)
background.FDR <- 
    con_vs_xdp.results.df %>% 
    pull(gene_name)
input_data.FDR <- 
    tibble(
        gene_group='XDP.FDR',
        hit_genes=list(gene_list.FDR), 
        background_genes=list(background.FDR)
    )
```
Calculate fisher tests
```{r Enrichments_FDR}
check_cached_results(
    results_file=ENRICHMENTS_FDR_FILE,
    force_redo=TRUE,
    return_data=FALSE,
    show_col_types=FALSE,
    results_fnc=run_enrichments,
    term_df=functional.groups.df,
    input_df=input_data.FDR
)
```

### Nominal (pvalue < 0.05 & abs(lfc) > 1.2)

Load gene list for `NO.CON vs NO.XDP` DEGs with pvalue < 0.05 & abs(LFC)}
```{r GeneList_Nominal}
gene_list.Nominal <- 
    con_vs_xdp.results.df %>%
    filter(pvalue < 0.05 & abs(lfc) >= 1.2) %>%
    pull(gene_name)
background.Nominal <- 
    con_vs_xdp.results.df %>% 
    pull(gene_name)
input_data.Nominal <- 
    tibble(
        gene_group='XDP.Nominal',
        hit_genes=list(gene_list.Nominal), 
        background_genes=list(background.Nominal)
    )
```
Calculate fisher tests
```{r Enrichments_Nominal}
check_cached_results(
    results_file=ENRICHMENTS_NOMINAL_FILE,
    force_redo=TRUE,
    return_data=FALSE,
    show_col_types=FALSE,
    results_fnc=run_enrichments,
    term_df=functional.groups.df,
    input_df=input_data.Nominal
)
```

## dSVA + ASO Rescued Gene Lists + Enrichments

Turn gene rescue dat into a set of lists + backgrounds to test for enrichment against functional groups.
This produces 8 Treatments x 3 different rescue criteria = 24 gene sets to test.
```{r GeneList_Rescued}
gene_list.rescued_genes <- 
    rescued_genes.df %>%
    dplyr::select(-c(isRescued)) %>% 
    mutate(isRescued.Both=isRescued.Naive & isRescued.2ZTests) %>% 
    mutate(isRescued.Neither=!isRescued.Naive & !isRescued.2ZTests) %>% 
    pivot_longer(
        where(is.logical),
        names_to='gene_group',
        values_to='isRescued'
    ) %>%
    filter(gene_group %in% 
        c(
            'isRescued.2ZTests',
            'isRescued.Both',
            'isRescued.Naive'
        )
    ) %>% 
    group_by(Treatment, gene_group) %>% 
    summarize(
        hit_mask=list(isRescued),
        background_genes=list(gene_name),
    ) %>%
    rowwise() %>% 
    mutate(hit_genes=list(background_genes[hit_mask])) %>%
    ungroup() %>%
    mutate(
        Treatment=
            case_when(
                Treatment == 'dSVA' ~ Treatment,
                TRUE ~ glue('ASO{Treatment}')
            )
    ) %>% 
    dplyr::select(-c(hit_mask))
gene_list.rescued_genes %>% dplyr::count(Treatment, gene_group)
```

### No Overlaps

Functional enrichments of Rescued genes (not overlapped with any other gene sets)
```{r enrichments_Rescues_Only}
gene_list.rescued_genes %>%
    mutate(
        results_file=
            file.path(
                ENRICHMENTS_DIR, 
                glue('Enrichments-RescuedGenes-{Treatment}-{gene_group}-NoOverlap.tsv')
            )
    ) %>% 
    rowwise() %>%
    group_split() %>%
    lapply(
    function(input_df, term_df){
        check_cached_results(
            results_file=input_df$results_file[[1]],
            force_redo=FALSE,
            return_data=FALSE,
            show_col_types=FALSE,
            results_fnc=run_enrichments,
            term_df=term_df,
            input_df=input_df %>% dplyr::select(-c(results_file))
        )
    },
    term_df=functional.groups.df
)
```

#### Overlaps with XDP DEGs (FDR < 0.1)

Functional enrichments of Rescued genes + XDF FDR DEGs
```{r enrichments_Rescues_FDR}
gene_list.rescued_genes %>%
    rowwise() %>%
    mutate(hit_genes=list(intersect(hit_genes, gene_list.FDR))) %>% 
    ungroup() %>% 
    mutate(
        results_file=
            file.path(
                ENRICHMENTS_DIR, 
                glue('Enrichments-RescuedGenes-{Treatment}-{gene_group}-XDP.FDR.tsv')
            )
    ) %>% 
    rowwise() %>%
    group_split() %>%
    lapply(
    function(input_df, term_df){
        check_cached_results(
            results_file=input_df$results_file[[1]],
            force_redo=FALSE,
            return_data=FALSE,
            show_col_types=FALSE,
            results_fnc=run_enrichments,
            term_df=term_df,
            input_df=input_df %>% dplyr::select(-c(results_file))
        )
    },
    term_df=functional.groups.df
)
```

#### Overlaps with XDP DEGs (pvalue < 0.05 & abs(lfc) > 1.2)

Functional enrichments of Rescued genes + XDF Nominal DEGs
```{r enrichments_Rescues_Nominal}
gene_list.rescued_genes %>%
    rowwise() %>%
    mutate(hit_genes=list(intersect(hit_genes, gene_list.Nominal))) %>% 
    ungroup() %>% 
    mutate(
        results_file=
            file.path(
                ENRICHMENTS_DIR, 
                glue('Enrichments-RescuedGenes-{Treatment}-{gene_group}-XDP.Nominal.tsv')
            )
    ) %>% 
    rowwise() %>%
    lapply(
    function(input_df, term_df){
        check_cached_results(
            results_file=input_df$results_file[[1]],
            force_redo=FALSE,
            return_data=FALSE,
            show_col_types=FALSE,
            results_fnc=run_enrichments,
            term_df=term_df,
            input_df=input_df %>% dplyr::select(-c(results_file))
        )
    },
    term_df=functional.groups.df
)
```
